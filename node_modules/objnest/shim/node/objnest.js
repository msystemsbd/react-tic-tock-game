'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _typeof2 = _interopRequireDefault(require("@babel/runtime/helpers/typeof"));

var extend = require('extend');

var abind = require('abind');

var isArrayKey = require('./key/is_array_key');

var fromArrayKey = require('./key/from_array_key');

var toArrayKey = require('./key/to_array_key');

var isRecursive = function isRecursive(value) {
  if (!value) {
    return false;
  }

  var reservedClasses = [Date];
  var isReservedClass = reservedClasses.some(function (C) {
    return value instanceof C;
  });

  if (isReservedClass) {
    return false;
  }

  switch ((0, _typeof2.default)(value)) {
    case 'string':
    case 'number':
    case 'boolean':
    case 'function':
      return false;

    default:
      return true;
  }
};
/**
 * @memberOf module:objnest
 * @class Objnest
 * @param {object} config
 */


function Objnest(config) {
  extend(this, config || {});
  abind(this);
}

Objnest.prototype = {
  separator: '.',

  /**
   * @function expand
   * @param {object} object - Obj to flatten
   * @returns {object} Flatten obj.
   * @example
   *  const obj = objnest.expand({
   *      'foo.bar': 'baz'
   *  })
   *  console.log(obj) // => {foo: {bar: 'baz'}}
   */
  expand: function expand(object) {
    var _this = this;

    if (Array.isArray(object)) {
      return object.map(function (object) {
        return _this.expand(object);
      });
    }

    if (!isRecursive(object)) {
      return object;
    }

    var separator = this.separator;
    var result = {};

    var _arr = Object.keys(object);

    for (var _i = 0; _i < _arr.length; _i++) {
      var key = _arr[_i];
      var val = object[key];
      var needsSeparate = !!~key.indexOf(separator);

      if (needsSeparate) {
        var subKeys = key.split(separator);
        var subObj = {};
        var thisKey = subKeys.shift();
        subObj[subKeys.join('.')] = val;
        var subExpandedObj = this.expand(subObj);
        var thisVal = result[thisKey];
        val = this._merge(thisVal, subExpandedObj);
        key = thisKey;
      }

      if (isArrayKey(key)) {
        var arrayKey = fromArrayKey(key);

        if (!result[arrayKey.name]) {
          var length = object["".concat(arrayKey.name, "[length]")] || 0;
          result[arrayKey.name] = new Array(length);
        }

        if (arrayKey.index !== null) {
          result[arrayKey.name][arrayKey.index] = this._merge(result[arrayKey.name][arrayKey.index], val);
        }
      } else {
        result[key] = val;
      }
    }

    return result;
  },

  /**
   * Flatten nested object.
   * @param {object} nested - Object to flatten.
   * @param {Object} [options={}]
   * @returns {object} - Flattened object.
   * @example
   *  const flattened = objnest.flatten({
   *      'foo': {'bar': 'baz'}
   *  })
   *  console.log(flattened) // => {'foo.bar': 'baz'}
   */
  flatten: function flatten(nested) {
    var _this2 = this;

    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
    var parent = options.parent;

    if (!isRecursive(nested)) {
      return nested;
    }

    var topLevelArray = Array.isArray(nested) && !parent;

    if (topLevelArray) {
      return nested.map(function (v) {
        return _this2.flatten(v);
      });
    }

    var separator = this.separator;
    var flattened = {};

    var _arr2 = Object.keys(nested || {});

    for (var _i2 = 0; _i2 < _arr2.length; _i2++) {
      var key = _arr2[_i2];
      var value = nested[key];

      if (value === null) {
        flattened[key] = value;
        continue;
      }

      if (isRecursive(value)) {
        var subValues = this.flatten(value, {
          parent: nested
        });
        var isArray = Array.isArray(value);

        if (isArray) {
          flattened["".concat(key, "[length]")] = value.length;
        }

        var _arr3 = Object.keys(subValues);

        for (var _i3 = 0; _i3 < _arr3.length; _i3++) {
          var subKey = _arr3[_i3];
          var fullKey = void 0;

          if (isArray) {
            fullKey = key + toArrayKey(subKey);
          } else {
            fullKey = [key, subKey].join(separator);
          }

          flattened[fullKey] = subValues[subKey];
        }
      } else {
        flattened[key] = value;
      }
    }

    return flattened;
  },
  _merge: function _merge(v1, v2) {
    if (typeof v1 === 'undefined') {
      return v2;
    }

    if (typeof v2 === 'undefined') {
      return v1;
    }

    return extend(true, v1, v2 || {});
  }
};
module.exports = Objnest;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm9iam5lc3QuanMiXSwibmFtZXMiOlsiZXh0ZW5kIiwicmVxdWlyZSIsImFiaW5kIiwiaXNBcnJheUtleSIsImZyb21BcnJheUtleSIsInRvQXJyYXlLZXkiLCJpc1JlY3Vyc2l2ZSIsInZhbHVlIiwicmVzZXJ2ZWRDbGFzc2VzIiwiRGF0ZSIsImlzUmVzZXJ2ZWRDbGFzcyIsInNvbWUiLCJDIiwiT2JqbmVzdCIsImNvbmZpZyIsInByb3RvdHlwZSIsInNlcGFyYXRvciIsImV4cGFuZCIsIm9iamVjdCIsIkFycmF5IiwiaXNBcnJheSIsIm1hcCIsInJlc3VsdCIsIk9iamVjdCIsImtleXMiLCJrZXkiLCJ2YWwiLCJuZWVkc1NlcGFyYXRlIiwiaW5kZXhPZiIsInN1YktleXMiLCJzcGxpdCIsInN1Yk9iaiIsInRoaXNLZXkiLCJzaGlmdCIsImpvaW4iLCJzdWJFeHBhbmRlZE9iaiIsInRoaXNWYWwiLCJfbWVyZ2UiLCJhcnJheUtleSIsIm5hbWUiLCJsZW5ndGgiLCJpbmRleCIsImZsYXR0ZW4iLCJuZXN0ZWQiLCJvcHRpb25zIiwicGFyZW50IiwidG9wTGV2ZWxBcnJheSIsInYiLCJmbGF0dGVuZWQiLCJzdWJWYWx1ZXMiLCJzdWJLZXkiLCJmdWxsS2V5IiwidjEiLCJ2MiIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7QUFFQSxJQUFNQSxNQUFNLEdBQUdDLE9BQU8sQ0FBQyxRQUFELENBQXRCOztBQUNBLElBQU1DLEtBQUssR0FBR0QsT0FBTyxDQUFDLE9BQUQsQ0FBckI7O0FBQ0EsSUFBTUUsVUFBVSxHQUFHRixPQUFPLENBQUMsb0JBQUQsQ0FBMUI7O0FBQ0EsSUFBTUcsWUFBWSxHQUFHSCxPQUFPLENBQUMsc0JBQUQsQ0FBNUI7O0FBQ0EsSUFBTUksVUFBVSxHQUFHSixPQUFPLENBQUMsb0JBQUQsQ0FBMUI7O0FBRUEsSUFBTUssV0FBVyxHQUFHLFNBQWRBLFdBQWMsQ0FBQ0MsS0FBRCxFQUFXO0FBQzdCLE1BQUksQ0FB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QUFDZCxRQUFJLE9BQU9ELEVBQVAsS0FBYyxXQUFsQixFQUErQjtBQUM3QixhQUFPQyxFQUFQO0FBQ0Q7O0FBQ0QsUUFBSSxPQUFPQSxFQUFQLEtBQWMsV0FBbEIsRUFBK0I7QUFDN0IsYUFBT0QsRUFBUDtBQUNEOztBQUNELFdBQU9wRCxNQUFNLENBQUMsSUFBRCxFQUFPb0QsRUFBUCxFQUFXQyxFQUFFLElBQUksRUFBakIsQ0FBYjtBQUNEO0FBN0dpQixDQUFwQjtBQWdIQUMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCMUMsT0FBakIiLCJzb3VyY2VSb290IjoiLi4vLi4vbGliIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnXG5cbmNvbnN0IGV4dGVuZCA9IHJlcXVpcmUoJ2V4dGVuZCcpXG5jb25zdCBhYmluZCA9IHJlcXVpcmUoJ2FiaW5kJylcbmNvbnN0IGlzQXJyYXlLZXkgPSByZXF1aXJlKCcuL2tleS9pc19hcnJheV9rZXknKVxuY29uc3QgZnJvbUFycmF5S2V5ID0gcmVxdWlyZSgnLi9rZXkvZnJvbV9hcnJheV9rZXknKVxuY29uc3QgdG9BcnJheUtleSA9IHJlcXVpcmUoJy4va2V5L3RvX2FycmF5X2tleScpXG5cbmNvbnN0IGlzUmVjdXJzaXZlID0gKHZhbHVlKSA9PiB7XG4gIGlmICghdmFsdWUpIHtcbiAgICByZXR1cm4gZmFsc2VcbiAgfVxuICBjb25zdCByZXNlcnZlZENsYXNzZXMgPSBbRGF0ZV1cbiAgY29uc3QgaXNSZXNlcnZlZENsYXNzID0gcmVzZXJ2ZWRDbGFzc2VzLnNvbWUoKEMpID0+IHZhbHVlIGluc3RhbmNlb2YgQylcbiAgaWYgKGlzUmVzZXJ2ZWRDbGFzcykge1xuICAgIHJldHVybiBmYWxzZVxuICB9XG4gIHN3aXRjaCAodHlwZW9mIHZhbHVlKSB7XG4gICAgY2FzZSAnc3RyaW5nJzpcbiAgICBjYXNlICdudW1iZXInOlxuICAgIGNhc2UgJ2Jvb2xlYW4nOlxuICAgIGNhc2UgJ2Z1bmN0aW9uJzpcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIGRlZmF1bHQ6XG4gICAgICByZXR1cm4gdHJ1ZVxuICB9XG59XG5cbi8qKlxuICogQG1lbWJlck9mIG1vZHVsZTpvYmpuZXN0XG4gKiBAY2xhc3MgT2JqbmVzdFxuICogQHBhcmFtIHtvYmplY3R9IGNvbmZpZ1xuICovXG5mdW5jdGlvbiBPYmpuZXN0IChjb25maWcpIHtcbiAgZXh0ZW5kKHRoaXMsIGNvbmZpZyB8fCB7fSlcbiAgYWJpbmQodGhpcylcbn1cblxuT2JqbmVzdC5wcm90b3R5cGUgPSB7XG4gIHNlcGFyYXRvcjogJy4nLFxuICAvKipcbiAgICogQGZ1bmN0aW9uIGV4cGFuZFxuICAgKiBAcGFyYW0ge29iamVjdH0gb2JqZWN0IC0gT2JqIHRvIGZsYXR0ZW5cbiAgICogQHJldHVybnMge29iamVjdH0gRmxhdHRlbiBvYmouXG4gICAqIEBleGFtcGxlXG4gICAqICBjb25zdCBvYmogPSBvYmpuZXN0LmV4cGFuZCh7XG4gICAqICAgICAgJ2Zvby5iYXInOiAnYmF6J1xuICAgKiAgfSlcbiAgICogIGNvbnNvbGUubG9nKG9iaikgLy8gPT4ge2Zvbzoge2JhcjogJ2Jheid9fVxuICAgKi9cbiAgZXhwYW5kIChvYmplY3QpIHtcbiAgICBpZiAoQXJyYXkuaXNBcnJheShvYmplY3QpKSB7XG4gICAgICByZXR1cm4gb2JqZWN0Lm1hcCgob2JqZWN0KSA9PiB0aGlzLmV4cGFuZChvYmplY3QpKVxuICAgIH1cbiAgICBpZighaXNSZWN1cnNpdmUob2JqZWN0KSl7XG4gICAgICByZXR1cm4gb2JqZWN0XG4gICAgfVxuICAgIGNvbnN0IHNlcGFyYXRvciA9IHRoaXMuc2VwYXJhdG9yXG4gICAgY29uc3QgcmVzdWx0ID0ge31cbiAgICBmb3IgKGxldCBrZXkgb2YgT2JqZWN0LmtleXMob2JqZWN0KSkge1xuICAgICAgbGV0IHZhbCA9IG9iamVjdFtrZXldXG4gICAgICBjb25zdCBuZWVkc1NlcGFyYXRlID0gISF+a2V5LmluZGV4T2Yoc2VwYXJhdG9yKVxuICAgICAgaWYgKG5lZWRzU2VwYXJhdGUpIHtcbiAgICAgICAgY29uc3Qgc3ViS2V5cyA9IGtleS5zcGxpdChzZXBhcmF0b3IpXG4gICAgICAgIGNvbnN0IHN1Yk9iaiA9IHt9XG4gICAgICAgIGNvbnN0IHRoaXNLZXkgPSBzdWJLZXlzLnNoaWZ0KClcbiAgICAgICAgc3ViT2JqW3N1YktleXMuam9pbignLicpXSA9IHZhbFxuICAgICAgICBjb25zdCBzdWJFeHBhbmRlZE9iaiA9IHRoaXMuZXhwYW5kKHN1Yk9iailcbiAgICAgICAgY29uc3QgdGhpc1ZhbCA9IHJlc3VsdFt0aGlzS2V5XVxuICAgICAgICB2YWwgPSB0aGlzLl9tZXJnZSh0aGlzVmFsLCBzdWJFeHBhbmRlZE9iailcbiAgICAgICAga2V5ID0gdGhpc0tleVxuICAgICAgfVxuICAgICAgaWYgKGlzQXJyYXlLZXkoa2V5KSkge1xuICAgICAgICBjb25zdCBhcnJheUtleSA9IGZyb21BcnJheUtleShrZXkpXG4gICAgICAgIGlmICghcmVzdWx0W2FycmF5S2V5Lm5hbWVdKSB7XG4gICAgICAgICAgY29uc3QgbGVuZ3RoID0gb2JqZWN0W2Ake2FycmF5S2V5Lm5hbWV9W2xlbmd0aF1gXSB8fCAwXG4gICAgICAgICAgcmVzdWx0W2FycmF5S2V5Lm5hbWVdID0gbmV3IEFycmF5KGxlbmd0aClcbiAgICAgICAgfVxuICAgICAgICBpZiAoYXJyYXlLZXkuaW5kZXggIT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHRbYXJyYXlLZXkubmFtZV1bYXJyYXlLZXkuaW5kZXhdID0gdGhpcy5fbWVyZ2UoXG4gICAgICAgICAgICByZXN1bHRbYXJyYXlLZXkubmFtZV1bYXJyYXlLZXkuaW5kZXhdLFxuICAgICAgICAgICAgdmFsXG4gICAgICAgICAgKVxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXN1bHRba2V5XSA9IHZhbFxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0XG4gIH0sXG4gIC8qKlxuICAgKiBGbGF0dGVuIG5lc3RlZCBvYmplY3QuXG4gICAqIEBwYXJhbSB7b2JqZWN0fSBuZXN0ZWQgLSBPYmplY3QgdG8gZmxhdHRlbi5cbiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zPXt9XVxuICAgKiBAcmV0dXJucyB7b2JqZWN0fSAtIEZsYXR0ZW5lZCBvYmplY3QuXG4gICAqIEBleGFtcGxlXG4gICAqICBjb25zdCBmbGF0dGVuZWQgPSBvYmpuZXN0LmZsYXR0ZW4oe1xuICAgKiAgICAgICdmb28nOiB7J2Jhcic6ICdiYXonfVxuICAgKiAgfSlcbiAgICogIGNvbnNvbGUubG9nKGZsYXR0ZW5lZCkgLy8gPT4geydmb28uYmFyJzogJ2Jheid9XG4gICAqL1xuICBmbGF0dGVuIChuZXN0ZWQsIG9wdGlvbnM9e30pIHtcbiAgICBjb25zdCB7cGFyZW50fSA9IG9wdGlvbnNcbiAgICBpZiAoIWlzUmVjdXJzaXZlKG5lc3RlZCkpIHtcbiAgICAgIHJldHVybiBuZXN0ZWRcbiAgICB9XG4gICAgY29uc3QgdG9wTGV2ZWxBcnJheSA9IEFycmF5LmlzQXJyYXkobmVzdGVkKSAmJiAhcGFyZW50XG4gICAgaWYodG9wTGV2ZWxBcnJheSl7XG4gICAgICByZXR1cm4gbmVzdGVkLm1hcCgodikgPT4gdGhpcy5mbGF0dGVuKHYpKVxuICAgIH1cbiAgICBjb25zdCBzZXBhcmF0b3IgPSB0aGlzLnNlcGFyYXRvclxuICAgIGNvbnN0IGZsYXR0ZW5lZCA9IHt9XG4gICAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0LmtleXMobmVzdGVkIHx8IHt9KSkge1xuICAgICAgY29uc3QgdmFsdWUgPSBuZXN0ZWRba2V5XVxuICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7XG4gICAgICAgIGZsYXR0ZW5lZFtrZXldID0gdmFsdWVcbiAgICAgICAgY29udGludWVcbiAgICAgIH1cbiAgICAgIGlmIChpc1JlY3Vyc2l2ZSh2YWx1ZSkpIHtcbiAgICAgICAgY29uc3Qgc3ViVmFsdWVzID0gdGhpcy5mbGF0dGVuKHZhbHVlLCB7cGFyZW50OiBuZXN0ZWR9KVxuICAgICAgICBjb25zdCBpc0FycmF5ID0gQXJyYXkuaXNBcnJheSh2YWx1ZSlcbiAgICAgICAgaWYgKGlzQXJyYXkpIHtcbiAgICAgICAgICBmbGF0dGVuZWRbYCR7a2V5fVtsZW5ndGhdYF0gPSB2YWx1ZS5sZW5ndGhcbiAgICAgICAgfVxuICAgICAgICBmb3IgKGNvbnN0IHN1YktleSBvZiBPYmplY3Qua2V5cyhzdWJWYWx1ZXMpKSB7XG4gICAgICAgICAgbGV0IGZ1bGxLZXlcbiAgICAgICAgICBpZiAoaXNBcnJheSkge1xuICAgICAgICAgICAgZnVsbEtleSA9IGtleSArIHRvQXJyYXlLZXkoc3ViS2V5KVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBmdWxsS2V5ID0gW2tleSwgc3ViS2V5XS5qb2luKHNlcGFyYXRvcilcbiAgICAgICAgICB9XG4gICAgICAgICAgZmxhdHRlbmVkW2Z1bGxLZXldID0gc3ViVmFsdWVzW3N1YktleV1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZmxhdHRlbmVkW2tleV0gPSB2YWx1ZVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmxhdHRlbmVkXG4gIH0sXG4gIF9tZXJnZSAodjEsIHYyKSB7XG4gICAgaWYgKHR5cGVvZiB2MSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHJldHVybiB2MlxuICAgIH1cbiAgICBpZiAodHlwZW9mIHYyID09PSAndW5kZWZpbmVkJykge1xuICAgICAgcmV0dXJuIHYxXG4gICAgfVxuICAgIHJldHVybiBleHRlbmQodHJ1ZSwgdjEsIHYyIHx8IHt9KVxuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gT2JqbmVzdFxuIl19